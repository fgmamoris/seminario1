<!DOCTYPE html>
<html lang="es">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <title>Lista de Productos</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <script>
      function mostrarPopup() {
        var popup = document.getElementById("popup");
        popup.classList.add("show-popup");
      }
      function mostrarPopupEdit() {
        var popup = document.getElementById("popup-edit");
        popup.classList.add("show-popup");
      }

      function cerrarPopup() {
        var popup = document.getElementById("popup");
        popup.classList.remove("show-popup");
      }
      function cerrarPopupEdit() {
        var popup = document.getElementById("popup-edit");
        popup.classList.remove("show-popup");
      }
    </script>
  </head>

  <body class="lista_productos">
    <div>
      <nav class="navbar">
        <div class="left">
          <img src="../static/img/logo-depositia.jpg" alt="Logo" class="logo" />
          <span>DEPOSIT IA</span>
        </div>
        <ul class="menu">
          <li><a href="">Inicio</a></li>
          <li><a href="#">Nosotros</a></li>
          <li class="submenu">
            <a href="#">Stock</a>
            <div class="submenu-content">
              <ul>
                <li>
                  <a data-toggle="modal" data-target="#modalProducto"
                    >Crear Producto</a
                  >
                </li>
                <li><a href="{% url 'lista_productos' %}">Productos</a></li>
              </ul>
            </div>
          </li>
          <li class="submenu">
            <a href="#">Logistica</a>
            <div class="submenu-content">
              <ul>
                <li><a href="#">Transportistas</a></li>
              </ul>
            </div>
          </li>
          <li class="submenu">
            <a href="">Pedidos</a>
            <div class="submenu-content">
              <ul>
                <li><a href="">Nuevo pedido</a></li>
                <li><a href="">Pedidos</a></li>
              </ul>
            </div>
          </li>
          <li><a href="#">Crear Cuenta</a></li>
          <li><a href="#">Ingresar</a></li>
        </ul>
      </nav>
    </div>
    <div id="popup" class="popup">
      <div class="swal2-popup swal2-show" style="display: flex">
        <div class="swal2-header">
          <ul class="swal2-progresssteps" style="display: none"></ul>
          <div
            class="swal2-icon swal2-success swal2-icon-show"
            style="display: none"
          >
            <div
              class="swal2-success-circular-line-left"
              style="background-color: rgb(255, 255, 255)"
            ></div>
            <span class="swal2-success-line-tip"></span>
            <span class="swal2-success-line-long"></span>
            <div class="swal2-success-ring"></div>
            <div
              class="swal2-success-fix"
              style="background-color: rgb(255, 255, 255)"
            ></div>
            <div
              class="swal2-success-circular-line-right"
              style="background-color: rgb(255, 255, 255)"
            ></div>
          </div>
          <img
            src="https://sweetalert2.github.io/images/thumbs-up.jpg"
            class="swal2-image"
            style="display: none"
          />
          <h2 class="swal2-title" id="swal2-title" style="display: flex">
            Producto creado exitosamente
          </h2>
        </div>
        <div class="swal2-actions">
          <button
            type="button"
            class="swal2-confirm swal2-styled"
            aria-label=""
            style="display: inline-block"
            onclick="cerrarPopup()"
          >
            Cerrar
          </button>
        </div>
        <div class="swal2-footer" style="display: none"></div>
        <input
          type="radio"
          class="swal2-radio swal2-hide"
          style="display: none"
        />
      </div>
    </div>
    <div id="popup-edit" class="popup">
      <div class="swal2-popup swal2-show" style="display: flex">
        <div class="swal2-header">
          <ul class="swal2-progresssteps" style="display: none"></ul>
          <div
            class="swal2-icon swal2-success swal2-icon-show"
            style="display: none"
          >
            <div
              class="swal2-success-circular-line-left"
              style="background-color: rgb(255, 255, 255)"
            ></div>
            <span class="swal2-success-line-tip"></span>
            <span class="swal2-success-line-long"></span>
            <div class="swal2-success-ring"></div>
            <div
              class="swal2-success-fix"
              style="background-color: rgb(255, 255, 255)"
            ></div>
            <div
              class="swal2-success-circular-line-right"
              style="background-color: rgb(255, 255, 255)"
            ></div>
          </div>
          <img
            src="https://sweetalert2.github.io/images/thumbs-up.jpg"
            class="swal2-image"
            style="display: none"
          />
          <h2 class="swal2-title" id="swal2-title" style="display: flex">
            Producto Modificado exitosamente
          </h2>
        </div>
        <div class="swal2-actions">
          <button
            type="button"
            class="swal2-confirm swal2-styled"
            aria-label=""
            style="display: inline-block"
            onclick="cerrarPopupEdit()"
          >
            Cerrar
          </button>
        </div>
        <div class="swal2-footer" style="display: none"></div>
        <input
          type="radio"
          class="swal2-radio swal2-hide"
          style="display: none"
        />
      </div>
    </div>
    <form id="formularioProducto">
      {% csrf_token %}
      <div
        class="modal fade"
        id="modalProducto"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">
                Formulario de Producto
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- Agrega tu formulario aquí -->
              <div class="form-group">
                <label for="nombre">Nombre del Producto</label>
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  placeholder="Nombre del Producto"
                  required
                />
              </div>
              <div class="form-group">
                <label for="cantidad">Cantidad</label>
                <input
                  type="number"
                  class="form-control"
                  id="cantidad"
                  placeholder="Cantidad"
                  required
                />
              </div>
              <div class="form-group">
                <label for="precio">Precio</label>
                <input
                  type="number"
                  class="form-control"
                  id="precio"
                  placeholder="Precio"
                  required
                />
              </div>
              <div class="form-group">
                <label for="descripcion">Descripción</label>
                <textarea
                  class="form-control"
                  id="descripcion"
                  rows="3"
                  placeholder="Descripción"
                  required
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cerrar
              </button>
              <button type="submit" class="btn btn-primary">Crear</button>
            </div>
          </div>
        </div>
      </div>
    </form>
    <form id="formularioProductoEdit">
      {% csrf_token %}
      <div
        class="modal fade"
        id="modalEditProducto"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">
                Editar Producto
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="nombre">Nombre del Producto</label>
                <input
                  type="text"
                  class="form-control"
                  id="nombre-edit"
                  placeholder="Nombre del Producto"
                  required
                />
              </div>
              <div class="form-group">
                <label for="cantidad">Cantidad</label>
                <input
                  type="number"
                  class="form-control"
                  id="cantidad-edit"
                  placeholder="Cantidad"
                  required
                />
              </div>
              <div class="form-group">
                <label for="precio">Precio</label>
                <input
                  type="number"
                  class="form-control"
                  id="precio-edit"
                  placeholder="Precio"
                  required
                />
              </div>
              <div class="form-group">
                <label for="descripcion">Descripción</label>
                <textarea
                  class="form-control"
                  id="descripcion-edit"
                  rows="3"
                  placeholder="Descripción"
                  required
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cerrar
              </button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </div>
        </div>
      </div>
    </form>
    <div class="container mt-4">
      <div class="col-md-8 d-flex align-items-center">
        <h1>Productos</h1>
      </div>
      {% for producto in productos %}
      <div class="row">
        <link rel="stylesheet" href="{% static '/css/style.css' %}" />
        <div class="col-md-12 producto">
          <img src="{% static 'caja.jpg' %}" alt="{{ producto.nombre }}" />
          <div class="producto-info mt-4">
            <h3>{{ producto.nombre }}</h3>
            <p>SKU: {{ producto.id }} - Cantidad: {{ producto.cantidad }}</p>
          </div>
          <div class="acciones">
            <div class="col-md-4 d-flex justify-content-end align-items-center">
              <a href="#" id="button">Ver</a>
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
              <a
                class="button edit-button"
                data-toggle="modal"
                data-target="#modalEditProducto"
                data-id="{{ producto.id }}"
                data-product-id="{{ producto.id }}"
                >Modificar</a
              >
              {% csrf_token %}
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
              <!-- <a href="#" class="button">Eliminar</a> -->
              <form
                action="{% url 'eliminar_producto' producto.id %}"
                method="post"
                style="display: inline"
              >
                {% csrf_token %}
                <input class="button" type="submit" value="Eliminar" />
              </form>
            </div>
            <!-- <section id="pr2" class="ch"> -->
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <script>
      document
        .getElementById("formularioProducto")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          var nombre = document.getElementById("nombre").value;
          var cantidad = document.getElementById("cantidad").value;
          var precio = document.getElementById("precio").value;
          var descripcion = document.getElementById("descripcion").value;

          // Envía la petición POST
          console.log(
            JSON.stringify({
              nombre: nombre,
              cantidad: cantidad,
              precio: precio,
              descripcion: descripcion,
            })
          );
          fetch("/crear_producto/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({
              nombre: nombre,
              cantidad: cantidad,
              precio: precio,
              descripcion: descripcion,
            }),
          })
            .then((response) => {
              return response.json();
            })
            .then((data) => {
              if (data.message === "Producto creado exitosamente.") {
                mostrarPopup();
                setTimeout(() => {
                  location.reload(); // Recarga la página después de 3 segundos
                }, 3000);
              }
              $("#modalProducto").modal("hide"); // Cierra el modal
            });
        });
      document.addEventListener("DOMContentLoaded", function () {
        var editButtons = document.querySelectorAll(".edit-button");

        editButtons.forEach(function (button) {
          button.addEventListener("click", function () {
            var productId = this.getAttribute("data-product-id");
            var modal = document.getElementById("modalEditProducto");
            var form = document.getElementById("formularioProductoEdit");
            console.error("hola");
            console.error(productId);

            if (form && productId) {
              form.dataset.productId = productId;
              form.action = "{% url 'modificar_producto' 0 %}".replace(
                "0",
                productId
              );

              fetch("{% url 'obtener_producto' 0 %}".replace("0", productId))
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Error al obtener los datos del producto");
                  }
                  return response.json();
                })
                .then((data) => {
                  document.getElementById("nombre-edit").value = data.nombre;
                  document.getElementById("cantidad-edit").value =
                    data.cantidad;
                  document.getElementById("precio-edit").value = data.precio;
                  document.getElementById("descripcion-edit").value =
                    data.descripcion;
                  console.log("hola2");
                  $("#modalEditProducto").modal("show");
                })
                .catch((error) => {
                  console.error(error);
                });
            } else {
              console.error("El formulario no se encontró en el DOM.");
            }
          });
        });

        document
          .getElementById("formularioProductoEdit")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            // Envía la petición POST
            fetch(this.action, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
              },
              body: JSON.stringify({
                nombre: document.getElementById("nombre-edit").value,
                cantidad: document.getElementById("cantidad-edit").value,
                precio: document.getElementById("precio-edit").value,
                descripcion: document.getElementById("descripcion-edit").value,
              }),
            })
              .then((response) => {
                return response.json();
              })
              .then((data) => {
                if (data.message === "Producto modificado exitosamente.") {
                  mostrarPopupEdit();
                  setTimeout(() => {
                    location.reload(); // Recarga la página después de 3 segundos
                  }, 3000);
                }
                $("#modalEditProducto").modal("hide");
              });
          });
      });
    </script>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  </body>
</html>
